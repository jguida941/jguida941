name: Update README

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "templates/**"
      - ".github/workflows/readme-scribe.yml"

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Pull latest
        run: git pull --rebase origin main

      - uses: muesli/readme-scribe@master
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        with:
          template: "templates/README.md.tpl"
          writeTo: "README.md"

      - name: Inject recent repos with languages
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        run: |
          gh api "users/jguida941/repos?per_page=100&sort=created&direction=desc" -q '
            [.[] | select(.fork == false)] | .[0:10] | .[] |
            "| [**\(.name)**](\(.html_url)) | \(.description // "n/a" | gsub("[|]"; ",")) | `\(.language // "n/a")` | \(.created_at[:10]) |"
          ' > /tmp/recent_repos.md

          {
            echo "| Repository | Description | Language | Created |"
            echo "|------------|-------------|----------|---------|"
            cat /tmp/recent_repos.md
          } > /tmp/recent_repos_table.md

          sed -i '/<!-- RECENT_REPOS -->/r /tmp/recent_repos_table.md' README.md
          sed -i '/<!-- RECENT_REPOS -->/d' README.md

      - name: Generate repo health badges
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        run: |
          REPOS_JSON=$(gh api "users/jguida941/repos?per_page=100" --paginate)
          TOTAL=$(echo "$REPOS_JSON" | jq '[.[] | select(.fork == false)] | length')
          LANG_COUNT=$(echo "$REPOS_JSON" | jq '[.[].language | select(. != null)] | unique | length')
          STARS=$(echo "$REPOS_JSON" | jq '[.[].stargazers_count] | add')

          CI_COUNT=0
          for repo in $(echo "$REPOS_JSON" | jq -r '[.[] | select(.fork == false)] | .[].name'); do
            result=$(gh api "repos/jguida941/$repo/contents/.github/workflows" 2>/dev/null | jq 'if type == "array" then length else 0 end' 2>/dev/null || echo "0")
            if [ "$result" -gt 0 ]; then
              CI_COUNT=$((CI_COUNT + 1))
            fi
          done

          echo "![Original Repos](https://img.shields.io/badge/Original_Repos-${TOTAL}-7AA2F7?style=for-the-badge&labelColor=1a1b27)" > /tmp/health.md
          echo "![CI/CD Pipelines](https://img.shields.io/badge/CI%2FCD_Pipelines-${CI_COUNT}-ff9e64?style=for-the-badge&labelColor=1a1b27)" >> /tmp/health.md
          echo "![Languages](https://img.shields.io/badge/Languages-${LANG_COUNT}-a9b1d6?style=for-the-badge&labelColor=1a1b27)" >> /tmp/health.md
          echo "![Stars Earned](https://img.shields.io/badge/Stars_Earned-${STARS}-e0af68?style=for-the-badge&labelColor=1a1b27)" >> /tmp/health.md
          echo "![Forked Repos](https://img.shields.io/badge/Forked_Repos-0-565f89?style=for-the-badge&labelColor=1a1b27)" >> /tmp/health.md

          sed -i '/<!-- REPO_HEALTH -->/r /tmp/health.md' README.md
          sed -i '/<!-- REPO_HEALTH -->/d' README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "update readme"
          branch: main
